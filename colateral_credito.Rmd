---
title: "Colateral y Crédito Comercial"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

# Base de datos y conexión desde R

# Avances previos

```{r}

# librerías
library(RODBC)
library(readr)

# conexión con la bd
ch <- odbcConnect("Teradata", uid = "jvelezve", pwd = "jindec2023")

# columnas de la tabla
mycol <- sqlColumns(ch, "PRO_SK_DATA_V.V_GT23_F341_SOL1")

# nombre de la tabla
tabla <- "PRO_SK_DATA_V.V_GT23_F341_SOL1"

```

```{r}

ruta <- "C:/Users/jvelezve/OneDrive - Banco de la República/Documents/Bancos/Felipe and Rebecca/output/columnas341.csv"

columnas <- read_csv(ruta)

```

# Nuevas queries y experimentación

  1. Que tan pobladas están las variables? Recuerdo que hay variables que tienen muchísimos NA. Para algunas puede ser normal como VALOR_GARANTIA_ME que mide el valor de la garantía denominada en moneda extranjera.

  2. Porcentaje de créditos con garantía (TIENE_GARANTIA)

  3. Porcentaje de créditos con garantía del crédito.

Creo estas tres cosas se deben hacer por tipo de crédito (CARTERA_TIPO)

## Valores faltantes

```{r, eval=FALSE}
library(stringr)

consulta <- character()

for (col in columnas$COLUMN_NAME){
  
  cadena <- paste0("COUNT(*)-COUNT(",col,") AS ", col)
  
  consulta <- paste(consulta, cadena, sep = ", ")
}

consulta <- str_remove(consulta, ",")

consulta <- paste0("SELECT", consulta)

consulta <- paste0(consulta, " FROM ", tabla)

df_nas <- sqlQuery(ch, consulta)

save(df_nas, file = "C:/Users/jvelezve/OneDrive - Banco de la República/Documents/Bancos/Felipe and Rebecca/output/Nas_by_col.rdata")

```

## Créditos con garantía

```{r}

# Agregación general

consulta <- "SELECT CARTERA_TIPO, TIENE_GARANTIA, COUNT(TIENE_GARANTIA) AS N_REG GROUP BY CARTERA_TIPO, TIENE_GARANTIA"

consulta <- paste0(consulta, " FROM ", tabla)

df_garantia <- sqlQuery(ch, consulta)

df_garantia

```

```{r}

# Agregación con más detalle

consulta <- "SELECT CARTERA_TIPO, TIENE_GARANTIA, TIPO_GARANTIA, COUNT(TIENE_GARANTIA) AS N_REG GROUP BY CARTERA_TIPO, TIENE_GARANTIA, TIPO_GARANTIA"

consulta <- paste0(consulta, " FROM ", tabla)

df_garantia <- sqlQuery(ch, consulta)

consulta

```


## Preguntas adicionales

  1. Definir préstamos en default si tiene 30 días o más de mora. Ver la cross-tabulation entre default y tener garantía.

  2. Ver el share de préstamos en default por CIIU.
  
  3. Ver el ratio de garantía/crédito por CIIU. 
  
  4. Explorar que tan populado es el tipo de garantía y ver como varía su valor. 

```{r}

# Pregunta 1

consulta <- paste0(
 "SELECT TIENE_GARANTIA, DIAS_DE_MORA, COUNT(*) AS N_REG, ",
 "CASE WHEN DIAS_DE_MORA >= 30 THEN 1 ELSE 0 END AS EN_MORA ",
 "GROUP BY TIENE_GARANTIA, EN_MORA"
)

consulta <- paste0(consulta, " FROM ", tabla)

df_defaults <- sqlQuery(ch, consulta)

consulta

```
